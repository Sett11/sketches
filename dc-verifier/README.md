# DCV (Data Chains Verifier)

Инструмент для проверки целостности цепочек данных между слоями приложения (Frontend → Backend → Database) **БЕЗ ЗАПУСКА приложения**.

## Концепция

DCV анализирует поток данных через граф вызовов:
1. Находит точку входа (main.py, app.py для Python; .ts/.tsx файлы для TypeScript)
2. Строит граф вызовов: отслеживает импорты → функции → классы → методы
3. Извлекает схемы данных (Pydantic модели, Zod схемы, TypeScript интерфейсы)
4. Идет по графу: main → route → handler → crud → model
5. Отслеживает поток данных через граф
6. Проверяет контракты на каждом стыке
7. Формирует отчет о несоответствиях

## Возможности

### Поддержка языков и фреймворков
- ✅ **Python/FastAPI** - парсинг Python кода, извлечение FastAPI routes, Pydantic моделей
- ✅ **TypeScript** - парсинг TypeScript кода, извлечение импортов, вызовов, функций, классов, методов, Zod схем, интерфейсов и type aliases

### Анализ кода
- ✅ **Построение графов вызовов** - автоматическое построение графа для Python и TypeScript проектов
- ✅ **Отслеживание потока данных** - отслеживание параметров и возвращаемых значений через граф
- ✅ **Проверка контрактов** - проверка соответствия схем данных на стыках цепочек

### Отчёты и визуализация
- ✅ **Форматы отчётов** - генерация отчётов в формате Markdown (по умолчанию) или JSON
- ✅ **Визуализация графов** - генерация DOT формата для визуализации графов вызовов
- ✅ **Прогресс-бары** - визуальная обратная связь для длительных операций

### Производительность и конфигурация
- ✅ **Кэширование** - сохранение и загрузка графов для ускорения повторных проверок
- ✅ **Ограничение глубины рекурсии** - настройка `max_recursion_depth` для больших проектов
- ✅ **Гибкая конфигурация** - поддержка множественных адаптеров и правил проверки
- ✅ **Валидация конфигурации** - детальные сообщения об ошибках при некорректной конфигурации
- ✅ **Типизированные ошибки** - использование `thiserror` для лучшей обработки ошибок

## Установка

```bash
cargo build --release
```

Бинарный файл будет находиться в `target/release/dc-verifier`.

## Использование

### Инициализация конфига

```bash
dc-verifier init
```

Создаст файл `dc-verifier.toml` с примером конфигурации.

### Проверка цепочек

```bash
# Markdown формат (по умолчанию)
dc-verifier check

# JSON формат
dc-verifier check --format json
```

Проверяет цепочки данных согласно конфигурации и генерирует отчет в формате Markdown или JSON. Во время выполнения отображаются прогресс-бары для отслеживания процесса обработки адаптеров и проверки контрактов.

### Визуализация графов

```bash
dc-verifier visualize
```

Генерирует DOT файлы для визуализации графов вызовов. Файлы можно открыть в Graphviz или онлайн-инструментах.

## Структура проекта

- `crates/dc-core/` - Ядро: построение графов, анализ потока данных, парсеры, анализаторы
- `crates/dc-adapter-fastapi/` - Адаптер для FastAPI (Python)
- `crates/dc-typescript/` - Адаптер для TypeScript
- `crates/dc-cli/` - CLI инструмент

## Конфигурация

Пример конфигурации для проекта с Python/FastAPI и TypeScript:

```toml
project_name = "my-project"

# Maximum recursion depth (optional, None = unlimited)
# Полезно для больших проектов, чтобы избежать бесконечной рекурсии
# max_recursion_depth = 100

[output]
format = "markdown"  # или "json"
path = "dc-verifier-report.md"

[[adapters]]
type = "fastapi"
app_path = "app/main.py"

[[adapters]]
type = "typescript"
src_paths = ["frontend/src", "shared"]

[rules]
type_mismatch = "critical"      # Проверка несоответствия типов
missing_field = "warning"        # Проверка отсутствующих полей
unnormalized_data = "warning"   # Проверка нормализации данных
```

### Адаптеры

#### FastAPI адаптер

```toml
[[adapters]]
type = "fastapi"
app_path = "app/main.py"  # Путь к файлу с FastAPI приложением
```

#### TypeScript адаптер

```toml
[[adapters]]
type = "typescript"
src_paths = ["src", "lib"]  # Директории с TypeScript файлами
```

**Примечание:** В конфигурации используется поле `type` (не `adapter_type`), которое автоматически маппится на `adapter_type` при загрузке конфигурации.

### Правила проверки

Правила проверки определяют уровень серьёзности для различных типов несоответствий:

```toml
[rules]
type_mismatch = "critical"     # Проверка несоответствия типов (critical/warning/info)
missing_field = "warning"       # Проверка отсутствующих полей (critical/warning/info)
unnormalized_data = "warning"  # Проверка нормализации данных (critical/warning/info)
```

Эти правила используются для определения severity в контрактах и влияют на итоговую статистику в отчётах.

## Примеры использования

### Python/FastAPI проект

```bash
# 1. Создать конфигурацию
dc-verifier init

# 2. Настроить dc-verifier.toml
# Указать путь к FastAPI приложению

# 3. Запустить проверку
dc-verifier check

# 4. Просмотреть отчет
cat dc-verifier-report.md

# Или сгенерировать JSON отчет
dc-verifier check --format json
cat dc-verifier-report.json
```

### TypeScript проект

```bash
# 1. Создать конфигурацию
dc-verifier init

# 2. Настроить dc-verifier.toml
# Указать директории с TypeScript файлами

# 3. Запустить проверку
dc-verifier check

# 4. Визуализировать граф
dc-verifier visualize
# Открыть сгенерированный .dot файл в Graphviz или онлайн-инструментах

# 5. Проверить цепочки с JSON отчетом
dc-verifier check --format json
```

### Смешанный проект (Python + TypeScript)

```toml
project_name = "fullstack-app"

# Ограничение глубины рекурсии для больших проектов
max_recursion_depth = 150

[output]
format = "json"  # Использовать JSON формат для интеграции с CI/CD
path = "dc-verifier-report.json"

[[adapters]]
type = "fastapi"
app_path = "backend/app/main.py"

[[adapters]]
type = "typescript"
src_paths = ["frontend/src"]

[rules]
type_mismatch = "critical"
missing_field = "warning"
unnormalized_data = "info"
```

## Что проверяется

DCV проверяет следующие аспекты цепочек данных:

1. **Соответствие типов** - проверяет, что типы данных совпадают на стыках цепочек
2. **Обязательные поля** - проверяет, что все обязательные поля присутствуют
3. **Нормализация данных** - проверяет валидацию (email, URL, паттерны)

## Форматы отчетов

DCV поддерживает два формата отчётов:

### Markdown (по умолчанию)
- **Человекочитаемый формат** с эмодзи и форматированием
- Включает статистику (total_chains, critical_issues, warnings, valid_chains)
- Детальная информация о каждой цепочке с путями данных и проверенными стыками
- Использование: `dc-verifier check` или `dc-verifier check --format markdown`

### JSON
- **Машинночитаемый формат** для интеграции с CI/CD и другими инструментами
- Включает версию отчёта, timestamp (RFC3339), summary и полные данные о цепочках
- Структурированный формат для автоматической обработки
- Использование: `dc-verifier check --format json`

Оба формата содержат одинаковую информацию, но представлены в разных форматах для удобства использования.

## Требования

- Rust 1.70+
- Python 3.8+ (для FastAPI адаптера)
- Node.js (не требуется, но может быть полезен для TypeScript проектов)

## Статус проекта

Проект готов к использованию. Текущая готовность: **~98-100%**.

### Реализовано

- ✅ Парсинг Python и TypeScript кода
- ✅ Построение графов вызовов для Python и TypeScript
- ✅ Извлечение функций, классов и методов из TypeScript AST
- ✅ Извлечение TypeScript интерфейсов и type aliases
- ✅ Связывание Zod схем с TypeScript типами
- ✅ Парсинг TypeScript схем в JsonSchema
- ✅ Отслеживание потока данных
- ✅ Проверка контрактов
- ✅ Визуализация графов
- ✅ Кэширование графов
- ✅ CLI интерфейс
- ✅ Валидация конфигурации с детальными сообщениями об ошибках (`Config::validate()`)
- ✅ Ограничение глубины рекурсии для больших проектов (`max_recursion_depth` в конфиге)
- ✅ Прогресс-бары для длительных операций (`indicatif::ProgressBar` в `check` и `visualize`)
- ✅ JSON формат отчетов (опция `--format json`, `JsonReporter`)
- ✅ Улучшенная обработка ошибок (типизированные ошибки через `thiserror`)
- ✅ Unit и integration тесты (все тесты проходят)

### В планах

- ⚠️ Улучшение документации (примеры использования)

## Лицензия

См. файл LICENSE (или Cargo.toml для информации о лицензии).

## Контрибуция

Проект открыт для контрибуций! См. детали в [CONTRIBUTING.md](CONTRIBUTING.md).

**Важно:** При добавлении новых функций или изменении существующих, пожалуйста, обновляйте:
- `README.md` - описание возможностей и примеры использования
- `AUDIT_REPORT.md` - детальная информация о реализации
- `CHANGELOG.md` - история изменений в формате Keep a Changelog
